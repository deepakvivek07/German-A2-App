<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>German A2 Prep</title>
  <style>
    :root{
      --brand:#0d6efd; --bg:#f6f7fb; --card:#ffffff; --text:#222; --muted:#666; --ok:#2e7d32; --bad:#c62828; --ink:#0b1020;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{background:var(--brand);color:#fff;padding:14px 20px;text-align:center}
    main{max-width:960px;margin:0 auto;padding:16px}
    .card{background:var(--card);border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:16px;margin:16px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:8px}
    button{appearance:none;border:0;border-radius:10px;padding:12px 16px;background:var(--brand);color:#fff;cursor:pointer;font-weight:600}
    button.ghost{background:#e9efff;color:#123}
    button.option{width:100%;text-align:left;background:#f3f6ff;color:#123;border:2px solid transparent}
    button.option:hover{border-color:#cad6ff}
    button.option.correct{border-color:var(--ok)}
    button.option.incorrect{border-color:var(--bad)}
    .title{font-size:22px;margin:0 0 6px}
    .muted{color:var(--muted);font-size:14px}
    .progress{height:10px;background:#e9ecf7;border-radius:999px;overflow:hidden;margin:8px 0 6px}
    .bar{height:100%;background:var(--brand);width:0%}
    .feedback{padding:10px 12px;border-left:4px solid #ddd;background:#f9fafc;border-radius:8px;margin-top:10px}
    .good{border-color:var(--ok)}
    .bad{border-color:var(--bad)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef5ff;color:#223;font-size:12px;margin-left:8px}
    .scorebox{display:flex;align-items:center;gap:12px}
    input[type="text"], textarea{width:100%;padding:12px;border:1px solid #dde2f1;border-radius:10px;font-size:16px}
    .hint{font-size:13px;color:#667}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .tile{background:#f7f9ff;border:1px solid #e6ecff;border-radius:12px;padding:14px}
    .tile h3{margin:0 0 6px;font-size:16px;color:var(--ink)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    @media (min-width:640px){button.option{width:calc(50% - 6px)}}
  </style>
</head>
<body>
  <header>
    <h1>German A2 Exam Prep</h1>
  </header>
  <main>
    <!-- HOME: Category Picker -->
    <section id="screen-home" class="card">
      <h2 class="title">Choose a skill</h2>
      <p class="muted">Focus: Everyday routines & frequently used sentences (family, shopping, entertainment).</p>
      <div class="grid">
        <div class="tile"><h3>Reading</h3><p class="hint">Flash Cards & Conversation Q&A</p><div class="actions"><button id="btn-reading" class="ghost">Open</button></div></div>
        <div class="tile"><h3>Listening</h3><p class="hint">Hear a sentence, pick the meaning</p><div class="actions"><button id="btn-listening" class="ghost">Open</button></div></div>
        <div class="tile"><h3>Speaking</h3><p class="hint">Say the sentence; auto-check (where supported)</p><div class="actions"><button id="btn-speaking" class="ghost">Open</button></div></div>
        <div class="tile"><h3>Writing</h3><p class="hint">Type the sentence correctly</p><div class="actions"><button id="btn-writing" class="ghost">Open</button></div></div>
      </div>
    </section>

    <!-- READING: sub modes -->
    <section id="screen-reading" class="card" style="display:none">
      <h2 class="title">Reading</h2>
      <p class="muted">Choose one</p>
      <div class="row">
        <button id="btn-flash" class="ghost">Flash Cards (15)</button>
        <button id="btn-convo" class="ghost">Conversation Q&A (15)</button>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="ghost" id="btn-back-home-rd">Back</button>
      </div>
    </section>

    <!-- EXERCISE PICKER for Listening/Speaking/Writing -->
    <section id="screen-exercises" class="card" style="display:none">
      <h2 id="ex-title" class="title">Exercises</h2>
      <div id="ex-list" class="grid"></div>
      <div class="row" style="margin-top:12px">
        <button class="ghost" id="btn-back-home-ex">Back</button>
      </div>
    </section>

    <!-- QUIZ -->
    <section id="screen-quiz" class="card" style="display:none">
      <div class="scorebox">
        <h2 id="mode-title" class="title" style="margin:0"></h2>
        <span id="counter" class="pill">1 / 10</span>
      </div>
      <div class="progress" aria-label="progress"><div id="bar" class="bar"></div></div>
      <p id="question" style="font-size:18px;margin:14px 0 8px"></p>

      <div id="listen-controls" style="display:none" class="row">
        <button id="btn-play">‚ñ∂Ô∏è Play</button>
        <button id="btn-replay" class="ghost">üîÅ Replay</button>
      </div>

      <div id="speak-controls" style="display:none" class="row">
        <button id="btn-speak-prompt">üîä Hear Target</button>
        <button id="btn-start-rec">üéôÔ∏è Start</button>
        <button id="btn-stop-rec" class="ghost">‚èπÔ∏è Stop</button>
        <span id="rec-status" class="hint"></span>
      </div>

      <div id="options" class="row"></div>
      <div id="write-box" style="display:none" class="col">
        <input id="write-input" type="text" placeholder="Type your answer in German‚Ä¶" />
        <button id="btn-check-write">Check</button>
      </div>

      <div id="feedback" class="feedback" style="display:none"></div>
      <div class="row">
        <button id="btn-next" style="display:none">Next</button>
        <button id="btn-quit" class="ghost">Exit</button>
      </div>
    </section>

    <!-- SUMMARY -->
    <section id="screen-summary" class="card" style="display:none">
      <h2 class="title">Summary</h2>
      <p class="muted" id="final-score"></p>
      <div style="overflow:auto;max-height:55vh">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Prompt (DE/EN)</th>
              <th>Correct (DE/EN)</th>
              <th>Your Answer</th>
              <th>Result</th>
            </tr>
          </thead>
          <tbody id="summary-body"></tbody>
        </table>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="btn-retry">Try Again</button>
        <button id="btn-home" class="ghost">Home</button>
      </div>
    </section>
  </main>

  <script>
    // ===== Utilities =====
    const el = id => document.getElementById(id);
    function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }

    // TTS helper (German voice preferred)
    function speak(text){ try{ const u = new SpeechSynthesisUtterance(text); u.lang = "de-DE"; u.rate=1; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){ console.warn("TTS not supported", e); } }

    // Levenshtein for speaking/writing similarity
    function lev(a,b){ a=a.toLowerCase(); b=b.toLowerCase(); const m=a.length,n=b.length; const dp=Array.from({length:m+1},()=>Array(n+1).fill(0)); for(let i=0;i<=m;i++)dp[i][0]=i; for(let j=0;j<=n;j++)dp[0][j]=j; for(let i=1;i<=m;i++){ for(let j=1;j<=n;j++){ const cost=a[i-1]===b[j-1]?0:1; dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost); } } return dp[m][n]; }
    function similarity(a,b){ if(!a||!b) return 0; const d=lev(a,b); return 1 - d / Math.max(a.length,b.length); }

    // ===== Data (Reading existing 15 each) =====
    const READING = {
      flash: [
        { q:"Woher kommst du?", qEn:"Where are you from?", options:["Ich komme aus Berlin.","Ich bin vierzehn Jahre alt.","Ich gehe zur Schule."], optionsEn:["I come from Berlin.","I am fourteen years old.","I go to school."], answer:"Ich komme aus Berlin.", answerEn:"I come from Berlin." },
        { q:"Wie alt bist du?", qEn:"How old are you?", options:["Ich bin vierzehn Jahre alt.","Ich komme mit dem Bus.","Ich habe Hunger."], optionsEn:["I am fourteen years old.","I come by bus.","I am hungry."], answer:"Ich bin vierzehn Jahre alt.", answerEn:"I am fourteen years old." },
        { q:"Was machst du gern?", qEn:"What do you like to do?", options:["Ich spiele gern Fu√üball.","Ich komme aus M√ºnchen.","Ich hei√üe Paul."], optionsEn:["I like playing football/soccer.","I come from Munich.","My name is Paul."], answer:"Ich spiele gern Fu√üball.", answerEn:"I like playing football/soccer." },
        { q:"Was ist dein Lieblingsfach?", qEn:"What is your favorite subject?", options:["Mein Lieblingsfach ist Mathe.","Ich esse Fr√ºhst√ºck.","Ich fahre Fahrrad."], optionsEn:["My favorite subject is math.","I eat breakfast.","I ride a bicycle."], answer:"Mein Lieblingsfach ist Mathe.", answerEn:"My favorite subject is math." },
        { q:"Wann fr√ºhst√ºckst du?", qEn:"When do you have breakfast?", options:["Ich fr√ºhst√ºcke um 7 Uhr.","Ich wohne in K√∂ln.","Ich spiele Klavier."], optionsEn:["I have breakfast at 7 o'clock.","I live in Cologne.","I play the piano."], answer:"Ich fr√ºhst√ºcke um 7 Uhr.", answerEn:"I have breakfast at 7 o'clock." },
        { q:"Wie kommst du zur Schule?", qEn:"How do you get to school?", options:["Ich fahre mit dem Bus.","Ich habe zwei Katzen.","Ich bin m√ºde."], optionsEn:["I go by bus.","I have two cats.","I am tired."], answer:"Ich fahre mit dem Bus.", answerEn:"I go by bus." },
        { q:"Was m√∂chtest du trinken?", qEn:"What would you like to drink?", options:["Ich m√∂chte Wasser, bitte.","Ich wohne in Hamburg.","Ich lerne Englisch."], optionsEn:["I'd like water, please.","I live in Hamburg.","I am learning English."], answer:"Ich m√∂chte Wasser, bitte.", answerEn:"I'd like water, please." },
        { q:"Wie ist das Wetter heute?", qEn:"What's the weather like today?", options:["Es ist sonnig.","Ich spiele Tennis.","Ich gehe ins Kino."], optionsEn:["It is sunny.","I play tennis.","I am going to the cinema."], answer:"Es ist sonnig.", answerEn:"It is sunny." },
        { q:"Was kostet das?", qEn:"How much does that cost?", options:["Es kostet zehn Euro.","Ich komme morgen.","Ich habe Durst."], optionsEn:["It costs ten euros.","I am coming tomorrow.","I am thirsty."], answer:"Es kostet zehn Euro.", answerEn:"It costs ten euros." },
        { q:"Wo ist die Toilette?", qEn:"Where is the restroom?", options:["Die Toilette ist dort dr√ºben.","Ich nehme den Zug.","Ich esse Suppe."], optionsEn:["The restroom is over there.","I take the train.","I eat soup."], answer:"Die Toilette ist dort dr√ºben.", answerEn:"The restroom is over there." },
        { q:"Hast du Geschwister?", qEn:"Do you have siblings?", options:["Ja, ich habe eine Schwester.","Ich wohne allein.","Ich trinke Kaffee."], optionsEn:["Yes, I have a sister.","I live alone.","I drink coffee."], answer:"Ja, ich habe eine Schwester.", answerEn:"Yes, I have a sister." },
        { q:"Was machst du am Wochenende?", qEn:"What do you do on the weekend?", options:["Ich treffe Freunde.","Ich nehme die U-Bahn.","Ich esse zu Mittag."], optionsEn:["I meet friends.","I take the subway.","I eat lunch."], answer:"Ich treffe Freunde.", answerEn:"I meet friends." },
        { q:"Wann hast du Deutsch?", qEn:"When do you have German class?", options:["Ich habe Deutsch am Montag.","Ich lerne in der Bibliothek.","Ich lese ein Buch."], optionsEn:["I have German on Monday.","I study in the library.","I am reading a book."], answer:"Ich habe Deutsch am Montag.", answerEn:"I have German on Monday." },
        { q:"Wie sp√§t ist es?", qEn:"What time is it?", options:["Es ist halb neun.","Ich spiele nach der Schule.","Ich gehe schwimmen."], optionsEn:["It is half past eight.","I play after school.","I go swimming."], answer:"Es ist halb neun.", answerEn:"It is half past eight." },
        { q:"Wo wohnst du?", qEn:"Where do you live?", options:["Ich wohne in M√ºnchen.","Ich mache Hausaufgaben.","Ich fahre nach Hause."], optionsEn:["I live in Munich.","I do homework.","I drive/go home."], answer:"Ich wohne in M√ºnchen.", answerEn:"I live in Munich." },
      ],
      convo: [
        { q:"Im Caf√©: Was bestellst du?", qEn:"At the caf√©: What do you order?", options:["Ich nehme einen Apfel.","Ich nehme einen Kaffee, bitte.","Ich gehe zur Schule."], optionsEn:["I'll take an apple.","I'll have a coffee, please.","I go to school."], answer:"Ich nehme einen Kaffee, bitte.", answerEn:"I'll have a coffee, please." },
        { q:"Beim B√§cker: Was sagst du?", qEn:"At the bakery: What do you say?", options:["Zwei Br√∂tchen, bitte.","Ich bin zw√∂lf Jahre alt.","Wo wohnst du?"], optionsEn:["Two bread rolls, please.","I am twelve years old.","Where do you live?"], answer:"Zwei Br√∂tchen, bitte.", answerEn:"Two bread rolls, please." },
        { q:"Nach dem Weg fragen:", qEn:"Asking for directions:", options:["Geradeaus und dann links.","Ich mag Musik.","Ich bin m√ºde."], optionsEn:["Straight ahead and then left.","I like music.","I am tired."], answer:"Geradeaus und dann links.", answerEn:"Straight ahead and then left." },
        { q:"Am Bahnhof: Wann f√§hrt der Zug?", qEn:"At the station: When does the train leave?", options:["Um neun Uhr.","Ich spiele Fu√üball.","Ich wohne in Bonn."], optionsEn:["At nine o'clock.","I play football/soccer.","I live in Bonn."], answer:"Um neun Uhr.", answerEn:"At nine o'clock." },
        { q:"Im Supermarkt an der Kasse:", qEn:"At the supermarket checkout:", options:["Ich m√∂chte mit Karte bezahlen.","Ich gehe tanzen.","Ich bin gro√ü."], optionsEn:["I'd like to pay by card.","I am going dancing.","I am tall."], answer:"Ich m√∂chte mit Karte bezahlen.", answerEn:"I'd like to pay by card." },
        { q:"Beim Arzt: Was sagst du?", qEn:"At the doctor's: What do you say?", options:["Ich habe Bauchschmerzen.","Ich bin im Park.","Ich mag Mathe."], optionsEn:["I have stomachache.","I am in the park.","I like math."], answer:"Ich habe Bauchschmerzen.", answerEn:"I have stomachache." },
        { q:"Termin machen:", qEn:"Making an appointment:", options:["Ich m√∂chte einen Termin am Dienstag.","Ich schwimme gern.","Ich esse Pizza."], optionsEn:["I'd like an appointment on Tuesday.","I like swimming.","I eat pizza."], answer:"Ich m√∂chte einen Termin am Dienstag.", answerEn:"I'd like an appointment on Tuesday." },
        { q:"Einladung ablehnen:", qEn:"Declining an invitation:", options:["Tut mir leid, ich kann nicht.","Ich bin f√ºnfzehn.","Ich lerne Deutsch."], optionsEn:["Sorry, I can't.","I am fifteen.","I am learning German."], answer:"Tut mir leid, ich kann nicht.", answerEn:"Sorry, I can't." },
        { q:"Im Hotel: Zimmerwunsch", qEn:"At the hotel: Room preference", options:["Ich m√∂chte ein Einzelzimmer.","Ich mag Katzen.","Ich gehe zu Fu√ü."], optionsEn:["I'd like a single room.","I like cats.","I go on foot."], answer:"Ich m√∂chte ein Einzelzimmer.", answerEn:"I'd like a single room." },
        { q:"Im Restaurant: Nach der Rechnung fragen", qEn:"In the restaurant: Asking for the bill", options:["Zahlen, bitte.","Ich bin satt.","Ich komme morgen."], optionsEn:["The bill, please.","I am full.","I am coming tomorrow."], answer:"Zahlen, bitte.", answerEn:"The bill, please." },
        { q:"In der Schule: Entschuldigen", qEn:"At school: Apologizing", options:["Entschuldigung, ich bin zu sp√§t.","Guten Morgen, Papa.","Ich habe Hunger."], optionsEn:["Sorry, I'm late.","Good morning, Dad.","I am hungry."], answer:"Entschuldigung, ich bin zu sp√§t.", answerEn:"Sorry, I'm late." },
        { q:"Beim Telefonieren:", qEn:"On the phone:", options:["K√∂nnen Sie das bitte wiederholen?", "Ich spiele am Samstag.", "Ich esse jetzt."], optionsEn:["Could you repeat that, please?","I play on Saturday.","I am eating now."], answer:"K√∂nnen Sie das bitte wiederholen?", answerEn:"Could you repeat that, please?" },
        { q:"Einen Vorschlag machen:", qEn:"Making a suggestion:", options:["Wollen wir ins Kino gehen?","Ich wohne in Berlin.","Ich trinke Tee."], optionsEn:["Shall we go to the cinema?","I live in Berlin.","I drink tea."], answer:"Wollen wir ins Kino gehen?", answerEn:"Shall we go to the cinema?" },
        { q:"Hilfe anbieten:", qEn:"Offering help:", options:["Kann ich dir helfen?","Ich hei√üe Anna.","Ich gehe nach Hause."], optionsEn:["Can I help you?","My name is Anna.","I'm going home."], answer:"Kann ich dir helfen?", answerEn:"Can I help you?" },
        { q:"Bei der Post:", qEn:"At the post office:", options:["Ich m√∂chte ein Paket schicken.","Ich habe Mathe.","Ich bin sehr m√ºde."], optionsEn:["I'd like to send a package.","I have math.","I am very tired."], answer:"Ich m√∂chte ein Paket schicken.", answerEn:"I'd like to send a package." },
      ]
    };

    // ===== Listening (5 exercises) =====
    const LISTENING = [
      { name:"Daily Routine", items:[
        { type:"listen", say:"Ich stehe um sieben Uhr auf.", q:"Listen and choose the meaning.", options:["I get up at seven o'clock.","I eat lunch at noon.","I go to bed at ten."], answer:"I get up at seven o'clock.", answerDe:"Ich stehe um sieben Uhr auf.", answerEn:"I get up at seven o'clock." },
        { type:"listen", say:"Ich fr√ºhst√ºcke mit meiner Familie.", q:"Listen and choose the meaning.", options:["I have breakfast with my family.","I study with my friends.","I take the bus to school."], answer:"I have breakfast with my family.", answerDe:"Ich fr√ºhst√ºcke mit meiner Familie.", answerEn:"I have breakfast with my family." },
        { type:"listen", say:"Ich gehe zur Schule.", q:"Listen and choose the meaning.", options:["I go to school.","I work at school.","I go to the cinema."], answer:"I go to school.", answerDe:"Ich gehe zur Schule.", answerEn:"I go to school." },
        { type:"listen", say:"Ich mache Hausaufgaben am Nachmittag.", q:"Listen and choose the meaning.", options:["I do homework in the afternoon.","I play soccer on Sunday.","I cook dinner in the evening."], answer:"I do homework in the afternoon.", answerDe:"Ich mache Hausaufgaben am Nachmittag.", answerEn:"I do homework in the afternoon." },
        { type:"listen", say:"Ich gehe um zehn Uhr ins Bett.", q:"Listen and choose the meaning.", options:["I go to bed at ten o'clock.","I get up at ten o'clock.","I read a book at ten o'clock."], answer:"I go to bed at ten o'clock.", answerDe:"Ich gehe um zehn Uhr ins Bett.", answerEn:"I go to bed at ten o'clock." },
        { type:"listen", say:"Ich komme mit dem Bus.", q:"Listen and choose the meaning.", options:["I come by bus.","I come by car.","I come on foot."], answer:"I come by bus.", answerDe:"Ich komme mit dem Bus.", answerEn:"I come by bus." },
      ]},
      { name:"Family", items:[
        { type:"listen", say:"Meine Schwester spielt gern Klavier.", q:"Meaning?", options:["My sister likes playing the piano.","My sister plays soccer on Monday.","My sister hates music."], answer:"My sister likes playing the piano.", answerDe:"Meine Schwester spielt gern Klavier.", answerEn:"My sister likes playing the piano." },
        { type:"listen", say:"Am Sonntag besuchen wir unsere Gro√üeltern.", q:"Meaning?", options:["On Sunday we visit our grandparents.","On Sunday we go shopping.","On Sunday we clean the house."], answer:"On Sunday we visit our grandparents.", answerDe:"Am Sonntag besuchen wir unsere Gro√üeltern.", answerEn:"On Sunday we visit our grandparents." },
        { type:"listen", say:"Mein Vater kocht heute Abend.", q:"Meaning?", options:["My father is cooking this evening.","My father goes to work this evening.","My father is reading this evening."], answer:"My father is cooking this evening.", answerDe:"Mein Vater kocht heute Abend.", answerEn:"My father is cooking this evening." },
        { type:"listen", say:"Ich helfe meiner Mutter im Garten.", q:"Meaning?", options:["I help my mother in the garden.","I help my mother in the kitchen.","I help my mother with homework."], answer:"I help my mother in the garden.", answerDe:"Ich helfe meiner Mutter im Garten.", answerEn:"I help my mother in the garden." },
        { type:"listen", say:"Wir essen zusammen zu Abend.", q:"Meaning?", options:["We have dinner together.","We have lunch together.","We have breakfast together."], answer:"We have dinner together.", answerDe:"Wir essen zusammen zu Abend.", answerEn:"We have dinner together." },
      ]},
      { name:"Shopping", items:[
        { type:"listen", say:"Wie viel kostet das Hemd?", q:"Meaning?", options:["How much does the shirt cost?","Where is the shirt?","What size is the shirt?"], answer:"How much does the shirt cost?", answerDe:"Wie viel kostet das Hemd?", answerEn:"How much does the shirt cost?" },
        { type:"listen", say:"Ich m√∂chte mit Karte bezahlen.", q:"Meaning?", options:["I would like to pay by card.","I would like to pay in cash.","I would like a discount."], answer:"I would like to pay by card.", answerDe:"Ich m√∂chte mit Karte bezahlen.", answerEn:"I would like to pay by card." },
        { type:"listen", say:"Haben Sie das in Gr√∂√üe M?", q:"Meaning?", options:["Do you have that in size M?","Do you have that in blue?","Do you have that cheaper?"], answer:"Do you have that in size M?", answerDe:"Haben Sie das in Gr√∂√üe M?", answerEn:"Do you have that in size M?" },
        { type:"listen", say:"Die Umkleidekabinen sind dort hinten.", q:"Meaning?", options:["The changing rooms are back there.","The changing rooms are closed.","The changing rooms are upstairs."], answer:"The changing rooms are back there.", answerDe:"Die Umkleidekabinen sind dort hinten.", answerEn:"The changing rooms are back there." },
        { type:"listen", say:"Ich suche ein g√ºnstiges Geschenk.", q:"Meaning?", options:["I am looking for an inexpensive gift.","I am looking for a big gift.","I am looking for a heavy gift."], answer:"I am looking for an inexpensive gift.", answerDe:"Ich suche ein g√ºnstiges Geschenk.", answerEn:"I am looking for an inexpensive gift." },
      ]},
      { name:"Entertainment", items:[
        { type:"listen", say:"Wollen wir heute Abend ins Kino gehen?", q:"Meaning?", options:["Shall we go to the cinema tonight?","Shall we go to the park tonight?","Shall we study tonight?"], answer:"Shall we go to the cinema tonight?", answerDe:"Wollen wir heute Abend ins Kino gehen?", answerEn:"Shall we go to the cinema tonight?" },
        { type:"listen", say:"Das Konzert beginnt um acht Uhr.", q:"Meaning?", options:["The concert starts at eight o'clock.","The concert ends at eight o'clock.","The concert is tomorrow at eight."], answer:"The concert starts at eight o'clock.", answerDe:"Das Konzert beginnt um acht Uhr.", answerEn:"The concert starts at eight o'clock." },
        { type:"listen", say:"Ich lade dich zu meiner Geburtstagsparty ein.", q:"Meaning?", options:["I invite you to my birthday party.","I am going to your birthday party.","I missed your birthday party."], answer:"I invite you to my birthday party.", answerDe:"Ich lade dich zu meiner Geburtstagsparty ein.", answerEn:"I invite you to my birthday party." },
        { type:"listen", say:"Wir treffen uns vor dem Theater.", q:"Meaning?", options:["We will meet in front of the theater.","We will meet behind the theater.","We will meet in the theater."], answer:"We will meet in front of the theater.", answerDe:"Wir treffen uns vor dem Theater.", answerEn:"We will meet in front of the theater." },
      ]},
      { name:"Travel & Directions", items:[
        { type:"listen", say:"Der Bahnhof ist geradeaus und dann links.", q:"Meaning?", options:["The station is straight ahead and then left.","The station is on the right.","The station is far away."], answer:"The station is straight ahead and then left.", answerDe:"Der Bahnhof ist geradeaus und dann links.", answerEn:"The station is straight ahead and then left." },
        { type:"listen", say:"Der Zug f√§hrt um neun Uhr ab.", q:"Meaning?", options:["The train departs at nine o'clock.","The train arrives at nine o'clock.","The train is delayed."], answer:"The train departs at nine o'clock.", answerDe:"Der Zug f√§hrt um neun Uhr ab.", answerEn:"The train departs at nine o'clock." },
        { type:"listen", say:"Gibt es hier in der N√§he eine Bushaltestelle?", q:"Meaning?", options:["Is there a bus stop nearby?","Is there a caf√© nearby?","Is there a restroom nearby?"], answer:"Is there a bus stop nearby?", answerDe:"Gibt es hier in der N√§he eine Bushaltestelle?", answerEn:"Is there a bus stop nearby?" },
      ]}
    ];

    // ===== Speaking (5 exercises) =====
    // Each item: say (target DE), prompt (EN), acceptable[] of DE variants
    const SPEAKING = [
      { name:"Daily Introductions", items:[
        { type:"speak", prompt:"Say: ‚ÄúMy name is Anna.‚Äù", say:"Ich hei√üe Anna.", acceptable:["ich hei√üe anna","mein name ist anna"], answerDe:"Ich hei√üe Anna.", answerEn:"My name is Anna." },
        { type:"speak", prompt:"Say: ‚ÄúI come from Berlin.‚Äù", say:"Ich komme aus Berlin.", acceptable:["ich komme aus berlin"], answerDe:"Ich komme aus Berlin.", answerEn:"I come from Berlin." },
        { type:"speak", prompt:"Say: ‚ÄúI am fourteen years old.‚Äù", say:"Ich bin vierzehn Jahre alt.", acceptable:["ich bin vierzehn jahre alt","ich bin 14 jahre alt"], answerDe:"Ich bin vierzehn Jahre alt.", answerEn:"I am fourteen years old." },
        { type:"speak", prompt:"Say: ‚ÄúI go to school by bus.‚Äù", say:"Ich fahre mit dem Bus zur Schule.", acceptable:["ich fahre mit dem bus zur schule","ich komme mit dem bus zur schule"], answerDe:"Ich fahre mit dem Bus zur Schule.", answerEn:"I go to school by bus." },
      ]},
      { name:"Family & Friends", items:[
        { type:"speak", prompt:"Say: ‚ÄúI have one sister.‚Äù", say:"Ich habe eine Schwester.", acceptable:["ich habe eine schwester"], answerDe:"Ich habe eine Schwester.", answerEn:"I have one sister." },
        { type:"speak", prompt:"Say: ‚ÄúWe visit our grandparents on Sunday.‚Äù", say:"Am Sonntag besuchen wir unsere Gro√üeltern.", acceptable:["am sonntag besuchen wir unsere gro√üeltern","sonntag besuchen wir unsere gro√üeltern"], answerDe:"Am Sonntag besuchen wir unsere Gro√üeltern.", answerEn:"On Sunday we visit our grandparents." },
        { type:"speak", prompt:"Say: ‚ÄúCan I help you?‚Äù", say:"Kann ich dir helfen?", acceptable:["kann ich dir helfen","kann ich ihnen helfen"], answerDe:"Kann ich dir helfen?", answerEn:"Can I help you?" },
      ]},
      { name:"Shopping", items:[
        { type:"speak", prompt:"Say: ‚ÄúDo you have this in size M?‚Äù", say:"Haben Sie das in Gr√∂√üe M?", acceptable:["haben sie das in gr√∂√üe m","habt ihr das in gr√∂√üe m"], answerDe:"Haben Sie das in Gr√∂√üe M?", answerEn:"Do you have that in size M?" },
        { type:"speak", prompt:"Say: ‚ÄúI would like to pay by card.‚Äù", say:"Ich m√∂chte mit Karte bezahlen.", acceptable:["ich m√∂chte mit karte bezahlen"], answerDe:"Ich m√∂chte mit Karte bezahlen.", answerEn:"I would like to pay by card." },
      ]},
      { name:"Dining & Entertainment", items:[
        { type:"speak", prompt:"Say: ‚ÄúThe bill, please.‚Äù", say:"Zahlen, bitte.", acceptable:["zahlen bitte","ich m√∂chte zahlen bitte"], answerDe:"Zahlen, bitte.", answerEn:"The bill, please." },
        { type:"speak", prompt:"Say: ‚ÄúShall we go to the cinema?‚Äù", say:"Wollen wir ins Kino gehen?", acceptable:["wollen wir ins kino gehen"], answerDe:"Wollen wir ins Kino gehen?", answerEn:"Shall we go to the cinema?" },
      ]},
      { name:"Everyday Routine", items:[
        { type:"speak", prompt:"Say: ‚ÄúI get up at seven o‚Äôclock.‚Äù", say:"Ich stehe um sieben Uhr auf.", acceptable:["ich stehe um sieben uhr auf"], answerDe:"Ich stehe um sieben Uhr auf.", answerEn:"I get up at seven o'clock." },
        { type:"speak", prompt:"Say: ‚ÄúI do my homework in the afternoon.‚Äù", say:"Ich mache am Nachmittag meine Hausaufgaben.", acceptable:["ich mache am nachmittag meine hausaufgaben","ich mache hausaufgaben am nachmittag"], answerDe:"Ich mache am Nachmittag meine Hausaufgaben.", answerEn:"I do my homework in the afternoon." },
      ]}
    ];

    // ===== Writing (5 exercises) =====
    // Each item: prompt EN + type input; acceptable answers in DE
    const WRITING = [
      { name:"Daily Routine", items:[
        { type:"write", prompt:"Write in German: ‚ÄúI have breakfast at seven o'clock.‚Äù", answerDe:"Ich fr√ºhst√ºcke um sieben Uhr.", acceptable:["ich fr√ºhst√ºcke um sieben uhr","ich fruehstuecke um sieben uhr"], answerEn:"I have breakfast at seven o'clock." },
        { type:"write", prompt:"Write in German: ‚ÄúI go to school by bus.‚Äù", answerDe:"Ich fahre mit dem Bus zur Schule.", acceptable:["ich fahre mit dem bus zur schule"], answerEn:"I go to school by bus." },
        { type:"write", prompt:"Write in German: ‚ÄúI go to bed at ten.‚Äù", answerDe:"Ich gehe um zehn Uhr ins Bett.", acceptable:["ich gehe um zehn uhr ins bett"], answerEn:"I go to bed at ten." },
      ]},
      { name:"Family", items:[
        { type:"write", prompt:"Write: ‚ÄúYes, I have a sister.‚Äù", answerDe:"Ja, ich habe eine Schwester.", acceptable:["ja ich habe eine schwester"], answerEn:"Yes, I have a sister." },
        { type:"write", prompt:"Write: ‚ÄúWe visit our grandparents on Sunday.‚Äù", answerDe:"Am Sonntag besuchen wir unsere Gro√üeltern.", acceptable:["am sonntag besuchen wir unsere gro√üeltern"], answerEn:"On Sunday we visit our grandparents." },
      ]},
      { name:"Shopping", items:[
        { type:"write", prompt:"Write: ‚ÄúWhere are the changing rooms?‚Äù", answerDe:"Wo sind die Umkleidekabinen?", acceptable:["wo sind die umkleidekabinen"], answerEn:"Where are the changing rooms?" },
        { type:"write", prompt:"Write: ‚ÄúHow much does that cost?‚Äù", answerDe:"Wie viel kostet das?", acceptable:["wie viel kostet das","wieviel kostet das"], answerEn:"How much does that cost?" },
        { type:"write", prompt:"Write: ‚ÄúI would like water, please.‚Äù", answerDe:"Ich m√∂chte Wasser, bitte.", acceptable:["ich m√∂chte wasser bitte","ich moechte wasser bitte"], answerEn:"I'd like water, please." },
      ]},
      { name:"Entertainment", items:[
        { type:"write", prompt:"Write: ‚ÄúShall we go to the cinema?‚Äù", answerDe:"Wollen wir ins Kino gehen?", acceptable:["wollen wir ins kino gehen"], answerEn:"Shall we go to the cinema?" },
        { type:"write", prompt:"Write: ‚ÄúThe concert starts at eight.‚Äù", answerDe:"Das Konzert beginnt um acht Uhr.", acceptable:["das konzert beginnt um acht uhr"], answerEn:"The concert starts at eight." },
      ]},
      { name:"Useful Phrases", items:[
        { type:"write", prompt:"Write: ‚ÄúCould you repeat that, please?‚Äù", answerDe:"K√∂nnen Sie das bitte wiederholen?", acceptable:["koennen sie das bitte wiederholen","k√∂nnen sie das bitte wiederholen"], answerEn:"Could you repeat that, please?" },
        { type:"write", prompt:"Write: ‚ÄúI am sorry, I can't.‚Äù", answerDe:"Tut mir leid, ich kann nicht.", acceptable:["tut mir leid ich kann nicht"], answerEn:"Sorry, I can't." },
      ]}
    ];

    // ===== State =====
    const state = {
      category:null,
      label:null,
      deck:[],
      index:0,
      score:0,
      answers:[],
      currentItem:null,
      recog:null,
      recogText:""
    };

    // ===== Navigation bindings =====
    el("btn-reading").onclick = ()=>{ show("screen-reading"); };
    el("btn-listening").onclick = ()=>{ showExercises("listening", LISTENING); };
    el("btn-speaking").onclick = ()=>{ showExercises("speaking", SPEAKING); };
    el("btn-writing").onclick = ()=>{ showExercises("writing", WRITING); };
    el("btn-back-home-rd").onclick = ()=>{ show("screen-home"); };
    el("btn-back-home-ex").onclick = ()=>{ show("screen-home"); };

    // Reading sub-modes
    el("btn-flash").onclick = ()=>startQuiz("reading","Reading ¬∑ Flash Cards", READING.flash);
    el("btn-convo").onclick = ()=>startQuiz("reading","Reading ¬∑ Conversation Q&A", READING.convo);

    // Generic show()
    function show(id){
      ["screen-home","screen-reading","screen-exercises","screen-quiz","screen-summary"].forEach(s=>el(s).style.display="none");
      el(id).style.display="block";
    }

    function showExercises(kind, bank){
      show("screen-exercises");
      el("ex-title").textContent = kind[0].toUpperCase()+kind.slice(1)+" ‚Äî choose an exercise";
      const list = el("ex-list"); list.innerHTML="";
      bank.forEach((ex, idx)=>{
        const d = document.createElement("div"); d.className="tile";
        d.innerHTML = `<h3>${idx+1}. ${ex.name}</h3><p class="hint">${(ex.items||[]).length} items</p><button class="ghost">Start</button>`;
        d.querySelector("button").onclick = ()=>{
          startQuiz(kind, `${kind[0].toUpperCase()+kind.slice(1)} ¬∑ ${ex.name}`, ex.items);
        };
        list.appendChild(d);
      });
    }

    function startQuiz(category, label, items){
      state.category = category; state.label = label;
      state.deck = shuffle([...(items||[])]);
      state.index = 0; state.score = 0; state.answers = [];
      el("mode-title").textContent = label;
      show("screen-quiz");
      renderQuestion();
    }

    function renderQuestion(){
      const total = state.deck.length; const i = state.index; const item = state.deck[i]; state.currentItem = item;
      el("counter").textContent = `${i+1} / ${total}`; el("bar").style.width = `${(i/Math.max(total,1))*100}%`;

      // Reset UI
      el("feedback").style.display="none"; el("feedback").innerHTML=""; el("btn-next").style.display="none";
      el("options").innerHTML=""; el("write-box").style.display="none"; el("listen-controls").style.display="none";
      el("speak-controls").style.display="none"; state.recogText="";

      // Prepare by type
      if(item.type==="listen"){
        el("question").textContent = item.q || "Listen and choose the meaning.";
        el("listen-controls").style.display="flex";
        el("btn-play").onclick = ()=>speak(item.say);
        el("btn-replay").onclick = ()=>speak(item.say);
        shuffle([...item.options]).forEach(opt=>{
          const b = document.createElement("button"); b.className="option"; b.textContent=opt; b.onclick=()=>checkMCQ(opt,item); el("options").appendChild(b);
        });
        speak(item.say);
      } else if(item.type==="speak"){
        el("question").textContent = item.prompt;
        el("speak-controls").style.display="flex";
        el("btn-speak-prompt").onclick = ()=>speak(item.say);
        setupRecognition(item);
        el("write-box").style.display="block";
        el("write-input").value="";
        el("btn-check-write").onclick = ()=>checkInput(el("write-input").value, item);
      } else if(item.type==="write"){
        el("question").textContent = item.prompt;
        el("write-box").style.display="block";
        el("write-input").value="";
        el("btn-check-write").onclick = ()=>checkInput(el("write-input").value, item);
      } else { // default mcq (Reading)
        el("question").textContent = item.q;
        shuffle([...item.options]).forEach(opt=>{
          const b = document.createElement("button"); b.className="option"; b.textContent=opt; b.onclick=()=>checkMCQ(opt,item); el("options").appendChild(b);
        });
      }
    }

    function checkMCQ(selected, item){
      [...el("options").children].forEach(c=>c.disabled=true);
      const correct = (selected===item.answer);
      if(correct) state.score++;
      [...el("options").children].forEach(c=>{
        if(c.textContent===item.answer) c.classList.add("correct");
        if(c.textContent===selected && !correct) c.classList.add("incorrect");
      });

      let html = `${correct?"‚úÖ Correct!":"‚ùå Not quite."}`;
      if(state.category==="reading"){
        const idx = (item.options||[]).indexOf(item.answer);
        const ansEn = idx>=0 && item.optionsEn ? item.optionsEn[idx] : (item.answerEn||"");
        const list = (item.options||[]).map((opt,i)=>{
          const mark = opt===item.answer ? " <strong>(correct)</strong>" : "";
          const en = item.optionsEn? ` ‚Äî <em>${item.optionsEn[i]}</em>`: "";
          return `<li>${opt}${en}${mark}</li>`;
        }).join("");
        html += `<div style="margin-top:6px"><strong>Question:</strong> ${item.q}<br><em>${item.qEn||""}</em></div>
                 <div style="margin-top:6px"><strong>Correct:</strong> ${item.answer}<br><em>${ansEn}</em></div>
                 <div style="margin-top:6px"><strong>Options:</strong><ul style="margin:6px 0 0 18px">${list}</ul></div>`;
        state.answers.push({qDe:item.q,qEn:item.qEn||"",correctDe:item.answer,correctEn:ansEn,your:selected,ok:correct});
      } else if(state.category==="listening"){
        html += `<div style="margin-top:6px"><strong>German you heard:</strong> ${item.say}</div>
                 <div style="margin-top:6px"><strong>Correct meaning:</strong> ${item.answer}</div>`;
        state.answers.push({qDe:item.say,qEn:"(listening)",correctDe:item.say,correctEn:item.answer,your:selected,ok:correct});
      }
      showFeedback(html);
    }

    function norm(s){ return (s||"").toLowerCase().replace(/√§/g,"ae").replace(/√∂/g,"oe").replace(/√º/g,"ue").replace(/√ü/g,"ss").replace(/[^a-z0-9 ]/g,"").replace(/ +/g," ").trim(); }

    function checkInput(text, item){
      const t = norm(text);
      const acc = (item.acceptable||[]).map(norm);
      const best = acc.reduce((m,a)=>Math.max(m, similarity(t,a)), 0);
      const ok = best>=0.8; if(ok) state.score++;
      const yourShow = text || "(no input)";
      const html = `${ok? "‚úÖ Looks good!":"‚ùå Keep practicing."}
        <div style="margin-top:6px"><strong>Target (DE):</strong> ${item.answerDe || item.say}</div>
        <div style="margin-top:6px"><em>${item.answerEn||""}</em></div>
        <div style="margin-top:6px"><strong>Your answer:</strong> ${yourShow}</div>
        <div class="hint">Similarity: ${(best*100).toFixed(0)}%</div>`;
      state.answers.push({qDe:item.answerDe||item.say,qEn:item.answerEn||"",correctDe:item.answerDe||item.say,correctEn:item.answerEn||"",your:yourShow,ok});
      showFeedback(html);
    }

    function showFeedback(html){
      const fb = el("feedback"); fb.className="feedback"; fb.style.display="block"; fb.innerHTML=html;
      el("btn-next").textContent = (state.index===state.deck.length-1)? "Finish" : "Next";
      el("btn-next").style.display="inline-block";
      el("btn-next").onclick = next;
    }

    function next(){
      if(state.index < state.deck.length-1){ state.index++; renderQuestion(); }
      else { finish(); }
    }

    function finish(){
      el("bar").style.width="100%"; show("screen-summary");
      el("final-score").textContent = `You scored ${state.score} / ${state.deck.length}`;
      const tb = el("summary-body"); tb.innerHTML="";
      state.answers.forEach((a,i)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i+1}</td><td>${a.qDe||""}<br><em>${a.qEn||""}</em></td><td>${a.correctDe||""}<br><em>${a.correctEn||""}</em></td><td>${a.your||a.your===0?a.your:"‚Äî"}</td><td>${a.ok?"‚úÖ":"‚ùå"}</td>`;
        tb.appendChild(tr);
      });
    }

    // ===== Speech Recognition setup for Speaking =====
    function setupRecognition(item){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const status = el("rec-status");
      if(!SR){ status.textContent="(Speech recognition not supported on this browser)"; return; }
      const rec = new SR(); rec.lang="de-DE"; rec.interimResults=true; rec.continuous=false; state.recog = rec;
      rec.onstart = ()=>{ status.textContent="Listening‚Ä¶"; };
      rec.onresult = (e)=>{
        let final=""; for(const r of e.results){ if(r.isFinal){ final += r[0].transcript + " "; } }
        if(final){ state.recogText = final.trim(); el("write-input").value = state.recogText; }
      };
      rec.onend = ()=>{ status.textContent = state.recogText? "Captured. Click Check." : "Stopped."; };
      rec.onerror = (e)=>{ status.textContent="Mic error. You can type instead."; console.warn(e); };
      el("btn-start-rec").onclick = ()=>{ try{ rec.start(); }catch{} };
      el("btn-stop-rec").onclick = ()=>{ try{ rec.stop(); }catch{} };
    }

    // ===== Global nav buttons =====
    el("btn-retry").onclick = ()=>startQuiz(state.category||"reading", state.label||"Practice", state.deck);
    el("btn-home").onclick = ()=>show("screen-home");
    el("btn-quit").onclick = ()=>show("screen-home");

    // Boot to home
    show("screen-home");
  </script>
</body>
</html>
